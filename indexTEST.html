<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memorie</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    
    <div class="overlay-menu">
        <section class="menu">
            <article class="BS">
                <h2>Meilleur score</h2>
                <p>0</p>
            </article>
            <h1>Nouvelle partie</h1>

            <article class="user">
                <h3>Nom d'utilisateur</h3>
                <input name="name" class="Default" type="text" value="User1"/>
                <p class="invalide hide">Le nom d'utilisateur doit contenir entre 1 et 10 caractères.</p>
            </article>
            <article class="Nb-choix">
                <h3>Nombre de cartes</h3>
                <select name="Nb" id="Nb">
                    <option class="SelecNbC" value="6">6 cartes</option>
                    <option class="SelecNbC" value="10">10 cartes</option>
                    <option class="SelecNbC" value="16">16 cartes</option>
                    <option class="SelecNbC" value="20">20 cartes</option>
                    <option class="SelecNbC" value="32">32 cartes</option>
                </select>
            </article>
        
            <article>
                <div class="Niveau-choix">
                    <h3>Niveau : </h3>
                    <div class="Niveau-S" id="0">
                        <input type="radio" name="Niveau" class="Niveaux" value="Niv1"> Facile<br>
                        <input type="radio" name="Niveau" class="Niveaux" value="Niv2"> Moyen<br>
                        <input type="radio" name="Niveau" class="Niveaux" value="Niv3"> Difficile<br>
                        <input type="radio" name="Niveau" class="Niveaux" value="Niv4"> IMPOSSIBLE<br>
                    </div>
                </div>
                <p class="invalide hide">Choisissez un niveau</p>
            </article>
        
            <button class="play" id="0">Jouer !</button>
            <a href="test.html">TEST</a>
            <a href="http://127.0.0.1:5500/Images">images</a>
        </section>
    </div>

    <div class="corps">
        <section id="paquet">

            <!--
                <article class="carte" id="C1"><p class="valeur">6</p></article>
            -->
        </section>
    
        <section class="commandes">
    
            <article class="Comm1" id="NbCartesAff">
                <h3>Nb de cartes</h3>
                <p id="nb"></p>
            </article>
    
            <article class="Comm1" id="CoupsRestantsAff">
                <h3>Coups restants</h3>
                <p id="coups"></p>
            </article>
    
            <article class="Comm1" id="ScoreAff">
                <h3>Score</h3>
                <p id="pts" value="v0"></p>
            </article>
    
            <button class="Comm1" id="New">Nouvelle partie</button>
            
        </section>
    </div>




    <script>

        /*BOUTONS DU MENU*/
        const BoutonJouer = document.querySelector(".play")
        const InputNom = document.querySelector(".user>input")
        const SelectionNombre = document.querySelector("#nb")
        const SelectNiv = document.querySelector('.Niveau-S')

        /*UNE PARTIE*/
        const cartes = document.querySelector("#nb")
        const coups = document.querySelector("#coups")
        const score = document.querySelector("#pts")

        let cartesFinit = []
        let NbCartesJouee = 0

        /*IMAGES*/
        const LienIMG = "http://127.0.0.1:5500/Images/"
        let index = [];
        let demiPaquet = [];        //que la moitié du paquet, sans doubles
        let paquet = [];                //paquet entier non mélangé
        let paquetM = [];               //le paquet mélangé

        let nbCartesActu = 0;
        let scoreActu = 0;

        const paquetAff = document.querySelector('#paquet') //dans la fonction distribution()

        //const images = []for(let i=0; i<17; i=i+1){LienIMG+i+".jpg"}

        /*NOUVELLE PARTIE*/
        document.querySelector("#New").addEventListener("click", NewParti)

        function NewParti(){
            document.querySelector(".BS>p").textContent = score.textContent
            document.querySelector(".overlay-menu").classList.remove("hide");
            //InputNom.value ="";
            index.splice(0, index.length);
            demiPaquet.splice(0, demiPaquet.length);
            paquet.splice(0, paquet.length);
            paquetM.splice(0, paquetM.length*2);
            paquetAff.innerHTML =''
        }

        let card1 =[];
        let card2 =[];

        /*check pour jouer*/
        BoutonJouer.addEventListener("click",gaming)  

        let onPlay = true

        function gaming(){
            if (!verifier()){                   /*avec les () parce qu'elle retourne un booléen (true ou false)*/
        }
            if (verifier()){

                const carteAff = initialisation();

                carteAff.forEach(function (i){
                    console.log("TEST - conditions")
                    i.addEventListener("click", ()=>{retourner(i)})   
                })
            }
        }


        function retourner(carte){

            if (!onPlay){
                console.log("non, perdu")
            }

            if (onPlay){

                document.querySelector("#"+carte.id+">p").classList.remove("hide");
                if (carte.classList.contains("true")){
                    if (card1.length==0){
                        card1.push(paquetM[parseInt(carte.id.substr(1))]);  //un ID ne pouvant pas n'être qu'un NB, il y a "C" avant, donc on le retire pour obtenir l'id (ca marchait pas sans le C) 
                        card1.push(carte.id.substr(1));

                        console.log(card1);
                        console.log(paquetM[1])
                        console.log(carte.id)
                        console.log("2EME LOG "+paquetM[parseInt(carte.id.substr(1))]);

                        carte.classList.remove("true");

                        coups.textContent = parseInt(coups.textContent)-1 
                    }else{
                        if (card2.length==0){
                            card2.push(paquetM[parseInt(carte.id.substr(1))]);
                            card2.push(carte.id.substr(1));

                            console.log(card2);
                            console.log("2EME LOG "+paquetM[parseInt(carte.id)]);

                            carte.classList.remove("true");

                            coups.textContent = parseInt(coups.textContent)-1 
                            
                            comparer(card1, card2)

                            cartes.textContent = nbCartesActu +" / "+SelecNbC.value;
                            let a= score.textContent
                        
                            setTimeout(()=>{actualiserScore(), 500})
                        }
                    }
                }
                if (parseInt(coups.textContent)==0){
                    onPlay = false
                }
                if ((nbCartesActu==SelecNbC.value) && parseInt(coups.textContent)>0){
                    console.log("gagné !!!")
                    setTimeout(()=>{gagne(), 1000})
                }
                if (parseInt(coups.textContent)<1){
                    let paquetIndex = []
                    for (i=0; i<paquetM.length;i=i+1){paquetIndex.push(i)}
                    setTimeout(()=>{paquetIndex.forEach((i)=>{
                        document.querySelector("#C"+i).style.backgroundColor="red";
                        document.querySelector("#C"+i+">p").classList.remove("hide")
                        })},2500);
                    setTimeout(()=>{perdu(), 1000})
                }
            }
        }


        //remplacer paquetM par une liste qui va de 0 à indicemax
        function gagne(){
            let paquetIndex = []
            for (i=0; i<paquetM.length;i=i+1){paquetIndex.push(i);console.log(i+paquetIndex)}
            setTimeout(()=>{clignotte(paquetIndex, 0, ["green", "rgb(181, 106, 57)"])},250);
            //
            //
            //
            //
            //
            //
            //
            //
            //
        }

        function perdu(){

            //
            //
            //
            //
            //
            //
            //
            //
            //
        }

        function actualiserScore(){
            if (score.textContent<scoreActu){
                score.textContent = parseInt(score.textContent) + 1;
                setTimeout(()=>{actualiserScore(), 500});
            }
        }

        function comparer(carte1, carte2){                  //carte1 et carte2 sont composés comme ça [[lien image, n° du double donc 1 ou 2], index dans le paquet utilisé]
            if (carte1[0][0] == carte2[0][0]){
                let listeB =[];
                listeB.push(carte1[1]);
                listeB.push(carte2[1]);
                setTimeout(()=>{clignotte(listeB, 4, ["green", "rgb(181, 106, 57)"])},250)
                card1.splice(0,card1.length)
                card2.splice(0,card2.length)
                
                nbCartesActu = nbCartesActu+2
                //nb.value = parseInt(nb.value)+2
                scoreActu = scoreActu + 150

            }

            else{
                document.querySelectorAll(".cartes")[parseInt(carte1[1])].classList.add("true")
                document.querySelectorAll(".cartes")[parseInt(carte2[1])].classList.add("true")



                let listeA =[];
                listeA.push(carte1[1]);
                listeA.push(carte2[1]);
                setTimeout(()=>{clignotte(listeA, 0, ["red", "rgb(181, 106, 57)"])},250);

                let i1 = carte1[1];
                let i2 = carte2[1];

                setTimeout(()=>{
                    document.querySelector("#C"+i1+">p").classList.add("hide");
                    document.querySelector("#C"+i2+">p").classList.add("hide");
                }, 2000);

                card1.splice(0,card1.length);
                card2.splice(0,card2.length);

            }
        }


        function clignotte(element, i, color){                        
            if (i<8){
                let c=color[0];
                element.forEach((i)=> {document.querySelector("#C"+i).style.backgroundColor=c});
                i=i+1;
                color = color.reverse();
                setTimeout(()=>{clignotte(element, i, color)},250)
            }else{return}
        }





        function initialisation(){

            while (index.length<(parseInt(SelecNbC.value)/2)){
                let a= (Math.floor(Math.random() * 100))% 17;
                if (!(index.includes(a)) && (a!=0)){
                    index.push(a)
                }
            }

            for (i=0; i<(index.length); i=i+1){           //On cherche les images associées au nb aléatoire (compris entre 1 et 16, prcque 16 images dans le fichier)
                demiPaquet.push(LienIMG+index[i]+".jpg")
            }

            for (i=0; i<(index.length); i=i+1){   //On copie toute ces images => le paquet du jeu est entier
                paquet.push([demiPaquet[i], 1]);          //le paquet aura la forme [[objet1, 1], [objet1, 2], [objet2, 1], [objet2, 2]...]
                paquet.push([demiPaquet[i], 2]);          //permet d'avoir des doublies différenciables
            }


            for (i=0; i<index.length*2; i=i+1){
                let a= (Math.floor(Math.random() * 100))% (index.length*2-i);
                paquetM.push(paquet[a]);     
                paquet.splice(a,1)           
            }

            paquetM.forEach((i) => distribution(i))
            const carteAff = document.querySelectorAll(".cartes")
            return(carteAff)
        }

        function distribution(carte){
            paquetAff.insertAdjacentHTML("beforeend",`
                <article class="cartes true" id="C${paquetM.findIndex((a) => a==carte)}" ><p class="image hide"></p></article>
                <style>
                    #C${paquetM.findIndex((a)=> a==carte)}>p{background-image: url("${carte[0]}");}
                </style>
            `)
        }





        /*
        (- Mettre en jeu le nb de cartes selectionné)

        INITIALISATION
        - Ajouter un nb suffisant de variables (ex : une image avec un certain id)
        - Mettre les variables dans des listes
        - Mélanger les cartes en faisant des randint, on place la carte, puis supprimer son index des possibilités du randint

        - Pourquoi pas mélanger ET ajouter les cartes en même temps (niveau facile on les vois qq instants)
        

        JEU
        - fonction qui se retourne elle-même avec 2 variables
        - variable 1 : première carte selectionnée
        - on attend
        - variable 2 : 2eme carte selectionnée
        - on attend
        - si les cartes sont identiques, elles clignottes en vert et disparaissent
        - des points sont ajoutés au score (200 % nbcartes * quotient déterminé par niveau)
        - si les cartes sont différentes, elles clignottes en rouge puis disparaissent
        - le score reste le même
        - fin de la partie quand nb de carte = 1 (100/100 ou 20/20, etc)


        SCORE
        - pour voir l'évolution, on fait pas score = score + 200
                    mais plutot for i in range(200) : score +=1
                    avec un time out de qq mili secondes

        FIN
        Une page s'affiche avec :
        - Score
        - Meilleur score
        - Rejouer
        
        */




        /*vérifier si les infos sont valides*/

        function verifier(){
            if (InputNom.value.length<1 || InputNom.value.length>10){                       //Si le nom d'utilisateurn'est pas conforme
                if (SelectNiv.id == "0"){                                                                //et que le niveau n'a pas été coché       = ensemble non conforme
                    document.querySelectorAll(".invalide")[0].classList.remove("hide");
                    InputNom.value = "";
                    document.querySelectorAll(".invalide")[1].classList.remove("hide");
                    return (false)
                }else{                                                                                   //mais que le niveau a été coché           = ensemble non confomre
                    document.querySelectorAll(".invalide")[0].classList.remove("hide");
                    InputNom.value = "";
                    document.querySelectorAll(".invalide")[1].classList.add("hide");
                    return (false)
                }
            }else{                                                                           //Si le nom d'utilisateur est conforme
                if (SelectNiv.id == "0"){                                                                //mais que le niveau n'a pas été coché     = ensemble non confomre
                    document.querySelectorAll(".invalide")[0].classList.add("hide");
                    document.querySelectorAll(".invalide")[1].classList.remove("hide");
                    return (false)
                }else{                                                                                  //et que le niveau est coché                 = tout est conforme
                    cartes.textContent = "0/"+SelecNbC.value
                    
                    if (parseInt(SelectNiv.id)==1){
                        coups.textContent = parseInt(SelecNbC.value)*4;
                    }
                    if (parseInt(SelectNiv.id)==2){
                        coups.textContent = parseInt(SelecNbC.value)*3;
                    }
                    if (parseInt(SelectNiv.id)==3){
                        coups.textContent = parseInt(SelecNbC.value)*2;
                    }
                    if (parseInt(SelectNiv.id)==4){
                        coups.textContent = parseInt(SelecNbC.value);
                    }

                    score.textContent = 0;
                    document.querySelectorAll(".invalide")[0].classList.add("hide");
                    document.querySelectorAll(".invalide")[1].classList.add("hide");

                    document.querySelector(".overlay-menu").classList.add("hide");
                    console.log(InputNom.value+SelecNbC.value+ SelectNiv.id);

                    return (true)

                }
            }
        }


        /*POUR L'EFFET SUR LE INPUT*/    /*WARNING : ce code est INTÉGRALEMENT DE MOI, mais je l'ai repris d'un autre de mes projets (le site Bento)*/
        document.querySelector("body").addEventListener("click",RetourDefaultNom)   //quand on uclick sur l'écran (n'importe où) => lancer fonction change()
        InputNom.addEventListener("click",Write)   //quand on uclick sur l'écran (n'importe où) => lancer fonction change()

        InputNom.onblur = inpBL;                   //quand input est inactif (que l'utilisateur a cliqué ailleurs pour faire autre chose)
        InputNom.onfocus = inpFOC;                 //quand l'utilisateur utilise input (la barre de texte est présente dans la zone de texte)

        function inpBL(){InputNom.classList.add("BLUR")}         //Pour connaître l'état de la zone de texte (dans les conditions de l'autre fonction)
        function inpFOC(){InputNom.classList.remove("BLUR")}     // si BLUR est une classe de input, alors l'utilisateur n'utilise pas la zone de texte

        function RetourDefaultNom(){
            if (!(InputNom.classList.contains("Default"))){
                if (InputNom.value == "" && InputNom.classList.contains("BLUR")){     //si input est vide ET la zone de texte est déselectionnée
                    InputNom.value = "User1";      //Le texte redevient celui par défault, opacité 0.3 et reprend la classe Default.
                    InputNom.style.color = "rgb(0,0,0,0.4)";
                    InputNom.classList.add("Default");
                    
                    //L'ajout de la condition BLUR évite que input se remete automatiquement
                    //en valeur par défault lorsque l'utilisateur avait simplement effacé du texte
                    //pour changer l'adresse e-mail qu'il veut mettre. Ca créait un bug, aussi.
                }
            }
        }

        function Write(){
            if (InputNom.classList.contains("Default")){         //Pour savoir si le texte a cette valeur par défault, ou si L'UTILISATEUR a recopier la valeur par défault
                InputNom.value = "";                             //La zone de texte se vide automatiquement
                InputNom.style.color = "rgb(0,0,0,1)";           //Et l'opacité revient à 1
                InputNom.classList.remove("Default");            //Ce n'est plus une valeur par défault mais bien le texte de l'utilisateur
            }
        }


        /*NOMBRE DE CARTES*/

        const SelecNbC = document.querySelector("#Nb")  //la valeur selectionnée est SelecNbC.value


        /*NIVEAU*/
        /*a chaque fois qu'on en coche un, une variable change (par exemple, value, d'une variable plus globale)*/
        const niv1 = document.querySelectorAll(".Niveaux")[0]    //On associe la constante "niv1" à la section de code (le input) correspondant au 1er niveau
        const niv2 = document.querySelectorAll(".Niveaux")[1]
        const niv3 = document.querySelectorAll(".Niveaux")[2]
        const niv4 = document.querySelectorAll(".Niveaux")[3]

        niv1.addEventListener("change", () => {SelectNiv.id = "1"})  //en selectionnant ou reselectionnant ce input, le id du div prend sa valeur
        niv2.addEventListener("change", () => {SelectNiv.id = "2"})  //donc le id du div.Niveau-S correspond à la valeur sélectionnée, à chaque instant.
        niv3.addEventListener("change", () => {SelectNiv.id = "3"})
        niv4.addEventListener("change", () => {SelectNiv.id = "4"})


    </script>

</body>
</html>